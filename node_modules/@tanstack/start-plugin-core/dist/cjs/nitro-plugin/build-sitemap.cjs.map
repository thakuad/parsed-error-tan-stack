{"version":3,"file":"build-sitemap.cjs","sources":["../../../src/nitro-plugin/build-sitemap.ts"],"sourcesContent":["import { writeFileSync } from 'node:fs'\nimport path from 'node:path'\nimport { create } from 'xmlbuilder2'\nimport { createLogger } from '../utils'\nimport type { TanStackStartOutputConfig } from '../plugin'\nimport type { XMLBuilder } from 'xmlbuilder2/lib/interfaces'\n\nexport type SitemapUrl = {\n  loc: string\n  lastmod: string\n  priority?: number\n  changefreq?:\n    | 'always'\n    | 'hourly'\n    | 'daily'\n    | 'weekly'\n    | 'monthly'\n    | 'yearly'\n    | 'never'\n  alternateRefs?: Array<{\n    href: string\n    hreflang?: string\n  }>\n  images?: Array<{\n    loc: string\n    title?: string\n    caption?: string\n  }>\n  news?: {\n    publication: {\n      name: string\n      language: string\n    }\n    publicationDate: string | Date\n    title: string\n  }\n}\n\nexport type SitemapData = {\n  urls: Array<SitemapUrl>\n}\n\nfunction buildSitemapJson(\n  pages: TanStackStartOutputConfig['pages'],\n  host: string,\n): SitemapData {\n  const slash = checkSlash(host)\n\n  const urls: Array<SitemapUrl> = pages\n    .filter((page) => {\n      return page.sitemap?.exclude !== true\n    })\n    .map((page) => ({\n      loc: `${host}${slash}${page.path.replace(/^\\/+/g, '')}`,\n      lastmod: page.sitemap?.lastmod\n        ? new Date(page.sitemap.lastmod).toISOString().split('T')[0]!\n        : new Date().toISOString().split('T')[0]!,\n      priority: page.sitemap?.priority,\n      changefreq: page.sitemap?.changefreq,\n      alternateRefs: page.sitemap?.alternateRefs,\n      images: page.sitemap?.images,\n      news: page.sitemap?.news,\n    }))\n\n  return { urls }\n}\n\nfunction jsonToXml(sitemapData: SitemapData): string {\n  const sitemap = createXml('urlset')\n\n  for (const item of sitemapData.urls) {\n    const page = sitemap.ele('url')\n    page.ele('loc').txt(item.loc)\n    page.ele('lastmod').txt(item.lastmod)\n\n    if (item.priority !== undefined) {\n      page.ele('priority').txt(item.priority.toString())\n    }\n    if (item.changefreq) {\n      page.ele('changefreq').txt(item.changefreq)\n    }\n\n    // Add alternate references\n    if (item.alternateRefs?.length) {\n      for (const ref of item.alternateRefs) {\n        const alternateRef = page.ele('xhtml:link')\n        alternateRef.att('rel', 'alternate')\n        alternateRef.att('href', ref.href)\n        if (ref.hreflang) {\n          alternateRef.att('hreflang', ref.hreflang)\n        }\n      }\n    }\n\n    // Add images\n    if (item.images?.length) {\n      for (const image of item.images) {\n        const imageElement = page.ele('image:image')\n        imageElement.ele('image:loc').txt(image.loc)\n        if (image.title) {\n          imageElement.ele('image:title').txt(image.title)\n        }\n        if (image.caption) {\n          imageElement.ele('image:caption').txt(image.caption)\n        }\n      }\n    }\n\n    // Add news\n    if (item.news) {\n      const newsElement = page.ele('news:news')\n      const publication = newsElement.ele('news:publication')\n      publication.ele('news:name').txt(item.news.publication.name)\n      publication.ele('news:language').txt(item.news.publication.language)\n      newsElement\n        .ele('news:publication_date')\n        .txt(new Date(item.news.publicationDate).toISOString().split('T')[0]!)\n      newsElement.ele('news:title').txt(item.news.title)\n    }\n  }\n\n  return sitemap.end({ prettyPrint: true })\n}\n\nexport function buildSitemap({\n  options,\n  publicDir,\n}: {\n  options: TanStackStartOutputConfig\n  publicDir: string\n}) {\n  const logger = createLogger('sitemap')\n\n  let sitemapOptions = options.sitemap\n\n  if (!sitemapOptions && options.pages.length) {\n    sitemapOptions = { enabled: true, outputPath: 'sitemap.xml' }\n  }\n\n  if (!sitemapOptions?.enabled) {\n    throw new Error('Sitemap is not enabled')\n  }\n\n  const { host, outputPath } = sitemapOptions\n\n  if (!host) {\n    if (!options.sitemap) {\n      logger.info(\n        'Hint: Pages found, but no sitemap host has been set. To enable sitemap generation, set the `sitemap.host` option.',\n      )\n      return\n    }\n    throw new Error(\n      'Sitemap host is not set and required to build the sitemap.',\n    )\n  }\n\n  if (!outputPath) {\n    throw new Error('Sitemap output path is not set')\n  }\n\n  const { pages } = options\n\n  if (!pages.length) {\n    logger.info('No pages were found to build the sitemap. Skipping...')\n    return\n  }\n\n  logger.info('Building Sitemap...')\n\n  // Build the sitemap data\n  const sitemapData = buildSitemapJson(pages, host)\n\n  // Generate output paths\n  const xmlOutputPath = path.join(publicDir, outputPath)\n  const pagesOutputPath = path.join(publicDir, 'pages.json')\n\n  try {\n    // Write XML sitemap\n    logger.info(`Writing sitemap XML at ${xmlOutputPath}`)\n    writeFileSync(xmlOutputPath, jsonToXml(sitemapData))\n\n    // Write pages data for runtime use\n    logger.info(`Writing pages data at ${pagesOutputPath}`)\n    writeFileSync(\n      pagesOutputPath,\n      JSON.stringify(\n        {\n          pages,\n          host,\n          lastBuilt: new Date().toISOString(),\n        },\n        null,\n        2,\n      ),\n    )\n  } catch (e) {\n    logger.error(`Unable to write sitemap files`, e)\n  }\n}\n\nfunction createXml(elementName: 'urlset' | 'sitemapindex'): XMLBuilder {\n  return create({ version: '1.0', encoding: 'UTF-8' })\n    .ele(elementName, {\n      xmlns: 'https://www.sitemaps.org/schemas/sitemap/0.9',\n    })\n    .com(`This file was automatically generated by TanStack Start.`)\n}\n\nfunction checkSlash(host: string): string {\n  const finalChar = host.slice(-1)\n  return finalChar === '/' ? '' : '/'\n}\n"],"names":["createLogger","writeFileSync","create"],"mappings":"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"}