{"version":3,"file":"server-functions-handler.js","sources":["../../src/server-functions-handler.ts"],"sourcesContent":["import { isNotFound } from '@tanstack/router-core'\nimport invariant from 'tiny-invariant'\nimport { startSerializer } from '@tanstack/start-client-core'\nimport { getEvent, getResponseStatus } from './h3'\nimport { VIRTUAL_MODULES } from './virtual-modules'\nimport { loadVirtualModule } from './loadVirtualModule'\n\nfunction sanitizeBase(base: string | undefined) {\n  if (!base) {\n    throw new Error(\n      'ðŸš¨ process.env.TSS_SERVER_FN_BASE is required in start/server-handler/index',\n    )\n  }\n\n  return base.replace(/^\\/|\\/$/g, '')\n}\n\nexport const handleServerAction = async ({ request }: { request: Request }) => {\n  const controller = new AbortController()\n  const signal = controller.signal\n  const abort = () => controller.abort()\n  request.signal.addEventListener('abort', abort)\n\n  const method = request.method\n  const url = new URL(request.url, 'http://localhost:3000')\n  // extract the serverFnId from the url as host/_serverFn/:serverFnId\n  // Define a regex to match the path and extract the :thing part\n  const regex = new RegExp(\n    `${sanitizeBase(process.env.TSS_SERVER_FN_BASE)}/([^/?#]+)`,\n  )\n\n  // Execute the regex\n  const match = url.pathname.match(regex)\n  const serverFnId = match ? match[1] : null\n  const search = Object.fromEntries(url.searchParams.entries()) as {\n    payload?: any\n    createServerFn?: boolean\n  }\n\n  const isCreateServerFn = 'createServerFn' in search\n  const isRaw = 'raw' in search\n\n  if (typeof serverFnId !== 'string') {\n    throw new Error('Invalid server action param for serverFnId: ' + serverFnId)\n  }\n\n  const { default: serverFnManifest } = await loadVirtualModule(\n    VIRTUAL_MODULES.serverFnManifest,\n  )\n\n  const serverFnInfo = serverFnManifest[serverFnId]\n\n  if (!serverFnInfo) {\n    console.info('serverFnManifest', serverFnManifest)\n    throw new Error('Server function info not found for ' + serverFnId)\n  }\n\n  const fnModule = await serverFnInfo.importer()\n\n  if (!fnModule) {\n    console.info('serverFnInfo', serverFnInfo)\n    throw new Error('Server function module not resolved for ' + serverFnId)\n  }\n\n  const action = fnModule[serverFnInfo.functionName]\n\n  if (!action) {\n    console.info('serverFnInfo', serverFnInfo)\n    console.info('fnModule', fnModule)\n    throw new Error(\n      `Server function module export not resolved for serverFn ID: ${serverFnId}`,\n    )\n  }\n\n  // Known FormData 'Content-Type' header values\n  const formDataContentTypes = [\n    'multipart/form-data',\n    'application/x-www-form-urlencoded',\n  ]\n\n  const response = await (async () => {\n    try {\n      let result = await (async () => {\n        // FormData\n        if (\n          request.headers.get('Content-Type') &&\n          formDataContentTypes.some((type) =>\n            request.headers.get('Content-Type')?.includes(type),\n          )\n        ) {\n          // We don't support GET requests with FormData payloads... that seems impossible\n          invariant(\n            method.toLowerCase() !== 'get',\n            'GET requests with FormData payloads are not supported',\n          )\n\n          return await action(await request.formData(), signal)\n        }\n\n        // Get requests use the query string\n        if (method.toLowerCase() === 'get') {\n          // By default the payload is the search params\n          let payload: any = search\n\n          // If this GET request was created by createServerFn,\n          // then the payload will be on the payload param\n          if (isCreateServerFn) {\n            payload = search.payload\n          }\n\n          // If there's a payload, we should try to parse it\n          payload = payload ? startSerializer.parse(payload) : payload\n\n          // Send it through!\n          return await action(payload, signal)\n        }\n\n        // This must be a POST request, likely JSON???\n        const jsonPayloadAsString = await request.text()\n\n        // We should probably try to deserialize the payload\n        // as JSON, but we'll just pass it through for now.\n        const payload = startSerializer.parse(jsonPayloadAsString)\n\n        // If this POST request was created by createServerFn,\n        // it's payload will be the only argument\n        if (isCreateServerFn) {\n          return await action(payload, signal)\n        }\n\n        // Otherwise, we'll spread the payload. Need to\n        // support `use server` functions that take multiple\n        // arguments.\n        return await action(...(payload as any), signal)\n      })()\n\n      // Any time we get a Response back, we should just\n      // return it immediately.\n      if (result.result instanceof Response) {\n        return result.result\n      }\n\n      // If this is a non createServerFn request, we need to\n      // pull out the result from the result object\n      if (!isCreateServerFn) {\n        result = result.result\n\n        // The result might again be a response,\n        // and if it is, return it.\n        if (result instanceof Response) {\n          return result\n        }\n      }\n\n      // if (!search.createServerFn) {\n      //   result = result.result\n      // }\n\n      // else if (\n      //   isPlainObject(result) &&\n      //   'result' in result &&\n      //   result.result instanceof Response\n      // ) {\n      //   return result.result\n      // }\n\n      // TODO: RSCs Where are we getting this package?\n      // if (isValidElement(result)) {\n      //   const { renderToPipeableStream } = await import(\n      //     // @ts-expect-error\n      //     'react-server-dom/server'\n      //   )\n\n      //   const pipeableStream = renderToPipeableStream(result)\n\n      //   setHeaders(event, {\n      //     'Content-Type': 'text/x-component',\n      //   } as any)\n\n      //   sendStream(event, response)\n      //   event._handled = true\n\n      //   return new Response(null, { status: 200 })\n      // }\n\n      if (isNotFound(result)) {\n        return isNotFoundResponse(result)\n      }\n\n      return new Response(\n        result !== undefined ? startSerializer.stringify(result) : undefined,\n        {\n          status: getResponseStatus(getEvent()),\n          headers: {\n            'Content-Type': 'application/json',\n          },\n        },\n      )\n    } catch (error: any) {\n      if (error instanceof Response) {\n        return error\n      }\n      // else if (\n      //   isPlainObject(error) &&\n      //   'result' in error &&\n      //   error.result instanceof Response\n      // ) {\n      //   return error.result\n      // }\n\n      // Currently this server-side context has no idea how to\n      // build final URLs, so we need to defer that to the client.\n      // The client will check for __redirect and __notFound keys,\n      // and if they exist, it will handle them appropriately.\n\n      if (isNotFound(error)) {\n        return isNotFoundResponse(error)\n      }\n\n      console.info()\n      console.info('Server Fn Error!')\n      console.info()\n      console.error(error)\n      console.info()\n\n      return new Response(startSerializer.stringify(error), {\n        status: 500,\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      })\n    }\n  })()\n\n  request.signal.removeEventListener('abort', abort)\n\n  if (isRaw) {\n    return response\n  }\n\n  return response\n}\n\nfunction isNotFoundResponse(error: any) {\n  const { headers, ...rest } = error\n\n  return new Response(JSON.stringify(rest), {\n    status: 200,\n    headers: {\n      'Content-Type': 'application/json',\n      ...(headers || {}),\n    },\n  })\n}\n"],"names":["payload"],"mappings":";;;;;;AAOA,SAAS,aAAa,MAA0B;AAC9C,MAAI,CAAC,MAAM;AACT,UAAM,IAAI;AAAA,MACR;AAAA,IACF;AAAA,EAAA;AAGK,SAAA,KAAK,QAAQ,YAAY,EAAE;AACpC;AAEO,MAAM,qBAAqB,OAAO,EAAE,cAAoC;AACvE,QAAA,aAAa,IAAI,gBAAgB;AACvC,QAAM,SAAS,WAAW;AACpB,QAAA,QAAQ,MAAM,WAAW,MAAM;AAC7B,UAAA,OAAO,iBAAiB,SAAS,KAAK;AAE9C,QAAM,SAAS,QAAQ;AACvB,QAAM,MAAM,IAAI,IAAI,QAAQ,KAAK,uBAAuB;AAGxD,QAAM,QAAQ,IAAI;AAAA,IAChB,GAAG,aAAa,QAAQ,IAAI,kBAAkB,CAAC;AAAA,EACjD;AAGA,QAAM,QAAQ,IAAI,SAAS,MAAM,KAAK;AACtC,QAAM,aAAa,QAAQ,MAAM,CAAC,IAAI;AACtC,QAAM,SAAS,OAAO,YAAY,IAAI,aAAa,SAAS;AAK5D,QAAM,mBAAmB,oBAAoB;AAC7C,QAAM,QAAQ,SAAS;AAEnB,MAAA,OAAO,eAAe,UAAU;AAC5B,UAAA,IAAI,MAAM,iDAAiD,UAAU;AAAA,EAAA;AAG7E,QAAM,EAAE,SAAS,iBAAiB,IAAI,MAAM;AAAA,IAC1C,gBAAgB;AAAA,EAClB;AAEM,QAAA,eAAe,iBAAiB,UAAU;AAEhD,MAAI,CAAC,cAAc;AACT,YAAA,KAAK,oBAAoB,gBAAgB;AAC3C,UAAA,IAAI,MAAM,wCAAwC,UAAU;AAAA,EAAA;AAG9D,QAAA,WAAW,MAAM,aAAa,SAAS;AAE7C,MAAI,CAAC,UAAU;AACL,YAAA,KAAK,gBAAgB,YAAY;AACnC,UAAA,IAAI,MAAM,6CAA6C,UAAU;AAAA,EAAA;AAGnE,QAAA,SAAS,SAAS,aAAa,YAAY;AAEjD,MAAI,CAAC,QAAQ;AACH,YAAA,KAAK,gBAAgB,YAAY;AACjC,YAAA,KAAK,YAAY,QAAQ;AACjC,UAAM,IAAI;AAAA,MACR,+DAA+D,UAAU;AAAA,IAC3E;AAAA,EAAA;AAIF,QAAM,uBAAuB;AAAA,IAC3B;AAAA,IACA;AAAA,EACF;AAEM,QAAA,WAAW,OAAO,YAAY;AAC9B,QAAA;AACE,UAAA,SAAS,OAAO,YAAY;AAE9B,YACE,QAAQ,QAAQ,IAAI,cAAc,KAClC,qBAAqB;AAAA,UAAK,CAAC,SACzB;;AAAA,iCAAQ,QAAQ,IAAI,cAAc,MAAlC,mBAAqC,SAAS;AAAA;AAAA,QAAI,GAEpD;AAEA;AAAA,YACE,OAAO,kBAAkB;AAAA,YACzB;AAAA,UACF;AAEA,iBAAO,MAAM,OAAO,MAAM,QAAQ,SAAA,GAAY,MAAM;AAAA,QAAA;AAIlD,YAAA,OAAO,YAAY,MAAM,OAAO;AAElC,cAAIA,WAAe;AAInB,cAAI,kBAAkB;AACpBA,uBAAU,OAAO;AAAA,UAAA;AAInBA,qBAAUA,WAAU,gBAAgB,MAAMA,QAAO,IAAIA;AAG9C,iBAAA,MAAM,OAAOA,UAAS,MAAM;AAAA,QAAA;AAI/B,cAAA,sBAAsB,MAAM,QAAQ,KAAK;AAIzC,cAAA,UAAU,gBAAgB,MAAM,mBAAmB;AAIzD,YAAI,kBAAkB;AACb,iBAAA,MAAM,OAAO,SAAS,MAAM;AAAA,QAAA;AAMrC,eAAO,MAAM,OAAO,GAAI,SAAiB,MAAM;AAAA,MAAA,GAC9C;AAIC,UAAA,OAAO,kBAAkB,UAAU;AACrC,eAAO,OAAO;AAAA,MAAA;AAKhB,UAAI,CAAC,kBAAkB;AACrB,iBAAS,OAAO;AAIhB,YAAI,kBAAkB,UAAU;AACvB,iBAAA;AAAA,QAAA;AAAA,MACT;AAkCE,UAAA,WAAW,MAAM,GAAG;AACtB,eAAO,mBAAmB,MAAM;AAAA,MAAA;AAGlC,aAAO,IAAI;AAAA,QACT,WAAW,SAAY,gBAAgB,UAAU,MAAM,IAAI;AAAA,QAC3D;AAAA,UACE,QAAQ,kBAAkB,UAAU;AAAA,UACpC,SAAS;AAAA,YACP,gBAAgB;AAAA,UAAA;AAAA,QAClB;AAAA,MAEJ;AAAA,aACO,OAAY;AACnB,UAAI,iBAAiB,UAAU;AACtB,eAAA;AAAA,MAAA;AAeL,UAAA,WAAW,KAAK,GAAG;AACrB,eAAO,mBAAmB,KAAK;AAAA,MAAA;AAGjC,cAAQ,KAAK;AACb,cAAQ,KAAK,kBAAkB;AAC/B,cAAQ,KAAK;AACb,cAAQ,MAAM,KAAK;AACnB,cAAQ,KAAK;AAEb,aAAO,IAAI,SAAS,gBAAgB,UAAU,KAAK,GAAG;AAAA,QACpD,QAAQ;AAAA,QACR,SAAS;AAAA,UACP,gBAAgB;AAAA,QAAA;AAAA,MAClB,CACD;AAAA,IAAA;AAAA,EACH,GACC;AAEK,UAAA,OAAO,oBAAoB,SAAS,KAAK;AAEjD,MAAI,OAAO;AACF,WAAA;AAAA,EAAA;AAGF,SAAA;AACT;AAEA,SAAS,mBAAmB,OAAY;AACtC,QAAM,EAAE,SAAS,GAAG,KAAA,IAAS;AAE7B,SAAO,IAAI,SAAS,KAAK,UAAU,IAAI,GAAG;AAAA,IACxC,QAAQ;AAAA,IACR,SAAS;AAAA,MACP,gBAAgB;AAAA,MAChB,GAAI,WAAW,CAAA;AAAA,IAAC;AAAA,EAClB,CACD;AACH;"}