{"version":3,"file":"start-compiler-plugin.js","sources":["../../src/start-compiler-plugin.ts"],"sourcesContent":["import { fileURLToPath, pathToFileURL } from 'node:url'\nimport { logDiff } from '@tanstack/router-utils'\n\nimport { VIRTUAL_MODULES } from '@tanstack/start-server-core'\nimport { compileStartOutputFactory } from './compilers'\nimport type { Plugin } from 'vite'\nimport type { CompileStartFrameworkOptions } from './compilers'\n\nconst debug =\n  process.env.TSR_VITE_DEBUG &&\n  ['true', 'start-plugin'].includes(process.env.TSR_VITE_DEBUG)\n\nexport type TanStackStartViteOptions = {\n  globalMiddlewareEntry: string\n}\n\nconst transformFuncs = [\n  'createServerFn',\n  'createMiddleware',\n  'serverOnly',\n  'clientOnly',\n  'createIsomorphicFn',\n  'createServerFileRoute',\n  'createServerRootRoute',\n]\n\nconst tokenRegex = new RegExp(transformFuncs.join('|'))\n\nexport function startCompilerPlugin(\n  framework: CompileStartFrameworkOptions,\n  inputOpts?: {\n    client?: {\n      envName?: string\n    }\n    server?: {\n      envName?: string\n    }\n  },\n): Plugin {\n  const opts = {\n    client: {\n      envName: 'client',\n      ...inputOpts?.client,\n    },\n    server: {\n      envName: 'server',\n      ...inputOpts?.server,\n    },\n  }\n\n  return {\n    name: 'vite-plugin-tanstack-start-create-server-fn',\n    enforce: 'pre',\n    applyToEnvironment(env) {\n      return [opts.client.envName, opts.server.envName].includes(env.name)\n    },\n    transform: {\n      filter: {\n        code: tokenRegex,\n        id: {\n          exclude: VIRTUAL_MODULES.serverFnManifest,\n        },\n      },\n      handler(code, id) {\n        const env =\n          this.environment.name === opts.client.envName\n            ? 'client'\n            : this.environment.name === opts.server.envName\n              ? 'server'\n              : (() => {\n                  throw new Error(\n                    `Environment ${this.environment.name} not configured`,\n                  )\n                })()\n\n        return transformCode({\n          code,\n          id,\n          env,\n          framework,\n        })\n      },\n    },\n  }\n}\n\nfunction transformCode(opts: {\n  code: string\n  id: string\n  env: 'server' | 'client'\n  framework: CompileStartFrameworkOptions\n}) {\n  const { code, env, framework } = opts\n  let { id } = opts\n\n  const url = pathToFileURL(id)\n  url.searchParams.delete('v')\n  id = fileURLToPath(url).replace(/\\\\/g, '/')\n\n  if (debug) console.info(`${env} Compiling Start: `, id)\n\n  const compileStartOutput = compileStartOutputFactory(framework)\n  const compiled = compileStartOutput({\n    code,\n    filename: id,\n    env,\n  })\n\n  if (debug) {\n    logDiff(code, compiled.code)\n    console.log('Output:\\n', compiled.code + '\\n\\n')\n  }\n\n  return compiled\n}\n"],"names":[],"mappings":";;;;AAQA,MAAM,QACJ,QAAQ,IAAI,kBACZ,CAAC,QAAQ,cAAc,EAAE,SAAS,QAAQ,IAAI,cAAc;AAM9D,MAAM,iBAAiB;AAAA,EACrB;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEA,MAAM,aAAa,IAAI,OAAO,eAAe,KAAK,GAAG,CAAC;AAEtC,SAAA,oBACd,WACA,WAQQ;AACR,QAAM,OAAO;AAAA,IACX,QAAQ;AAAA,MACN,SAAS;AAAA,MACT,GAAG,uCAAW;AAAA,IAChB;AAAA,IACA,QAAQ;AAAA,MACN,SAAS;AAAA,MACT,GAAG,uCAAW;AAAA,IAAA;AAAA,EAElB;AAEO,SAAA;AAAA,IACL,MAAM;AAAA,IACN,SAAS;AAAA,IACT,mBAAmB,KAAK;AACf,aAAA,CAAC,KAAK,OAAO,SAAS,KAAK,OAAO,OAAO,EAAE,SAAS,IAAI,IAAI;AAAA,IACrE;AAAA,IACA,WAAW;AAAA,MACT,QAAQ;AAAA,QACN,MAAM;AAAA,QACN,IAAI;AAAA,UACF,SAAS,gBAAgB;AAAA,QAAA;AAAA,MAE7B;AAAA,MACA,QAAQ,MAAM,IAAI;AAChB,cAAM,MACJ,KAAK,YAAY,SAAS,KAAK,OAAO,UAClC,WACA,KAAK,YAAY,SAAS,KAAK,OAAO,UACpC,YACC,MAAM;AACL,gBAAM,IAAI;AAAA,YACR,eAAe,KAAK,YAAY,IAAI;AAAA,UACtC;AAAA,QAAA,GACC;AAEX,eAAO,cAAc;AAAA,UACnB;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QAAA,CACD;AAAA,MAAA;AAAA,IACH;AAAA,EAEJ;AACF;AAEA,SAAS,cAAc,MAKpB;AACD,QAAM,EAAE,MAAM,KAAK,UAAc,IAAA;AAC7B,MAAA,EAAE,OAAO;AAEP,QAAA,MAAM,cAAc,EAAE;AACxB,MAAA,aAAa,OAAO,GAAG;AAC3B,OAAK,cAAc,GAAG,EAAE,QAAQ,OAAO,GAAG;AAE1C,MAAI,MAAe,SAAA,KAAK,GAAG,GAAG,sBAAsB,EAAE;AAEhD,QAAA,qBAAqB,0BAA0B,SAAS;AAC9D,QAAM,WAAW,mBAAmB;AAAA,IAClC;AAAA,IACA,UAAU;AAAA,IACV;AAAA,EAAA,CACD;AAED,MAAI,OAAO;AACD,YAAA,MAAM,SAAS,IAAI;AAC3B,YAAQ,IAAI,aAAa,SAAS,OAAO,MAAM;AAAA,EAAA;AAG1C,SAAA;AACT;"}